pipeline:
  clone:
    image: plugins/git
    tags: true

  build:
    image: dock.pw.fr/pw/debpkg:jessie
    commands:
      - echo "deb http://ftp.fr.debian.org/debian/ jessie-backports main" > /etc/apt/sources.list.d/backports.list
      - apt-get update >/dev/null
      - apt-get install -y -t jessie-backports cmake libhiredis-dev libhiredis-dbg valgrind redis-server clang php5-dev libjson-c-dev
      - sed -i -e "s/6379/6380/" /etc/redis/redis.conf
      - echo "unixsocket /var/run/redis/redis-webconf.sock" >> /etc/redis/redis.conf
      - /etc/init.d/redis-server start
      - redis-cli -p 6380 SET WEBHOST/v1/website.com "{\"status\": \"enabled\", \"vhost\": \"www.website.com\", \"host\": \"www.website.com\", \"no_public_html\": 0, \"frontend\": {\"deny\": [], \"allow\": [\"ALL\"], \"redirect_https\": 0, \"proxy_only\": 0, \"HSTS\": \"\", \"env\": \"default\"}, \"user\": \"testuser\", \"directory\": \"www\", \"backend\": {\"mysql_socket\": \"/var/run/mysqld/mysqld.sock\", \"php_mode\": \"default\", \"php_config\": {\"default_charset\": \"iso-8859-1\", \"always_populate_raw_post_data\": \"-1\", \"display_errors\": \"On\"}}}"
      - scan-build make
      - scan-build make test_redis
      - make
      - make test_redis
      - ./test_redis website.com
      - valgrind ./test_redis website.com
      - dpkg-buildpackage -b

  pkg:
    image: appleboy/drone-scp
    host: pippin.planet-work.net
    username: pkg
    source: ../*.deb
    target: incoming/libapache2-mod-vhs/jessie
    when:
        event: tag

  aptly:
    image: appleboy/drone-ssh
    host: pippin.planet-work.net
    user: pkg
    script:
      - aptly repo add debian-jessie incoming/libapache2-mod-vhs/jessie && aptly publish update jessie debian 
    when:
      event: tag

matrix:
  DEBIAN_VERSION:
    - jessie

